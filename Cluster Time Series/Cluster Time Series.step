{"creationTimeStamp":"2023-05-18T17:52:46.336Z","modifiedTimeStamp":"2023-05-19T18:01:41.487Z","createdBy":"Stu.Sztukowski@sas.com","modifiedBy":"Stu.Sztukowski@sas.com","name":"Cluster Time Series.step","displayName":"Cluster Time Series.step","localDisplayName":"Cluster Time Series.step","properties":{},"links":[{"method":"GET","rel":"self","href":"/dataFlows/steps/d0761aa1-071e-49e6-a96a-9245a78deec3","uri":"/dataFlows/steps/d0761aa1-071e-49e6-a96a-9245a78deec3","type":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"alternate","href":"/dataFlows/steps/d0761aa1-071e-49e6-a96a-9245a78deec3","uri":"/dataFlows/steps/d0761aa1-071e-49e6-a96a-9245a78deec3","type":"application/vnd.sas.data.flow.step.summary"},{"method":"GET","rel":"up","href":"/dataFlows/steps","uri":"/dataFlows/steps","type":"application/vnd.sas.collection","itemType":"application/vnd.sas.data.flow.step.summary"},{"method":"PUT","rel":"update","href":"/dataFlows/steps/d0761aa1-071e-49e6-a96a-9245a78deec3","uri":"/dataFlows/steps/d0761aa1-071e-49e6-a96a-9245a78deec3","type":"application/vnd.sas.data.flow.step","responseType":"application/vnd.sas.data.flow.step"},{"method":"DELETE","rel":"delete","href":"/dataFlows/steps/d0761aa1-071e-49e6-a96a-9245a78deec3","uri":"/dataFlows/steps/d0761aa1-071e-49e6-a96a-9245a78deec3"},{"method":"GET","rel":"transferExport","href":"/dataFlows/steps/d0761aa1-071e-49e6-a96a-9245a78deec3","uri":"/dataFlows/steps/d0761aa1-071e-49e6-a96a-9245a78deec3","responseType":"application/vnd.sas.transfer.object"},{"method":"PUT","rel":"transferImportUpdate","href":"/dataFlows/steps/d0761aa1-071e-49e6-a96a-9245a78deec3","uri":"/dataFlows/steps/d0761aa1-071e-49e6-a96a-9245a78deec3","type":"application/vnd.sas.transfer.object","responseType":"application/vnd.sas.summary"}],"metadataVersion":0.0,"version":2,"type":"code","flowMetadata":{"inputPorts":[{"name":"input_table","displayName":"input_table","localDisplayName":"input_table","minEntries":1,"maxEntries":1,"defaultEntries":0,"type":"table"}],"outputPorts":[{"name":"outcluster","displayName":"outcluster","localDisplayName":"outcluster","minEntries":1,"maxEntries":1,"defaultEntries":0,"type":"table","supportsView":false,"requiresStructure":false},{"name":"outtree","displayName":"outtree","localDisplayName":"outtree","minEntries":0,"maxEntries":1,"defaultEntries":0,"type":"table","supportsView":false,"requiresStructure":false},{"name":"outmatrix","displayName":"outmatrix","localDisplayName":"outmatrix","minEntries":0,"maxEntries":1,"defaultEntries":0,"type":"table","supportsView":false,"requiresStructure":false}]},"ui":"{\n\t\"showPageContentOnly\": true,\n\t\"pages\": [\n\t\t{\n\t\t\t\"id\": \"Input\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Input\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"input_table\",\n\t\t\t\t\t\"type\": \"inputtable\",\n\t\t\t\t\t\"label\": \"Input CAS Data\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"readonly\": false\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"id\",\n\t\t\t\t\t\"type\": \"columnselector\",\n\t\t\t\t\t\"label\": \"Time ID\",\n\t\t\t\t\t\"order\": true,\n\t\t\t\t\t\"columntype\": \"n\",\n\t\t\t\t\t\"max\": 1,\n\t\t\t\t\t\"min\": 1,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"readonly\": false,\n\t\t\t\t\t\"table\": \"input_table\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"vars\",\n\t\t\t\t\t\"type\": \"columnselector\",\n\t\t\t\t\t\"label\": \"Variables to cluster\",\n\t\t\t\t\t\"order\": true,\n\t\t\t\t\t\"columntype\": \"n\",\n\t\t\t\t\t\"max\": null,\n\t\t\t\t\t\"min\": null,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"table\": \"input_table\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"Output\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Output\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"text1\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"Optional output datasets that are saved separately from the flow.\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"user_outcluster_select\",\n\t\t\t\t\t\"type\": \"radiogroup\",\n\t\t\t\t\t\"label\": \"Output clusters\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"Yes\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"No\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"user_outcluster\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Output cluster dataset\",\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": [\n\t\t\t\t\t\t\"$user_outcluster_select\",\n\t\t\t\t\t\t\"=\",\n\t\t\t\t\t\t\"Yes\"\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"user_outtree_select\",\n\t\t\t\t\t\"type\": \"radiogroup\",\n\t\t\t\t\t\"label\": \"Output tree for PROC TREE to draw a tree diagram\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"Yes\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"No\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"user_outtree\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Output tree dataset\",\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\"visible\": [\n\t\t\t\t\t\t\"$user_outtree_select\",\n\t\t\t\t\t\t\"=\",\n\t\t\t\t\t\t\"Yes\"\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"user_outmatrix_select\",\n\t\t\t\t\t\"type\": \"radiogroup\",\n\t\t\t\t\t\"label\": \"Output distance matrix\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"Yes\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"No\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"user_outmatrix\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Output distance matrix dataset\",\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\"visible\": [\n\t\t\t\t\t\t\"$user_outmatrix_select\",\n\t\t\t\t\t\t\"=\",\n\t\t\t\t\t\t\"Yes\"\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"flowout\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Flow Output\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"outcluster\",\n\t\t\t\t\t\"type\": \"outputtable\",\n\t\t\t\t\t\"label\": \"Output cluster dataset\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"outtree\",\n\t\t\t\t\t\"type\": \"outputtable\",\n\t\t\t\t\t\"label\": \"Output tree dataset\",\n\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"outmatrix\",\n\t\t\t\t\t\"type\": \"outputtable\",\n\t\t\t\t\t\"label\": \"Output distance matrix datsaet\",\n\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t],\n\t\"syntaxversion\": \"1.3.0\",\n\t\"values\": {\n\t\t\"input_table\": {\n\t\t\t\"library\": \"\",\n\t\t\t\"table\": \"\"\n\t\t},\n\t\t\"id\": [],\n\t\t\"vars\": [],\n\t\t\"user_outcluster_select\": {\n\t\t\t\"value\": \"No\"\n\t\t},\n\t\t\"user_outcluster\": \"WORK.OUTCLUSTER\",\n\t\t\"user_outtree_select\": {\n\t\t\t\"value\": \"No\"\n\t\t},\n\t\t\"user_outtree\": \"WORK.OUTTREE\",\n\t\t\"user_outmatrix_select\": {\n\t\t\t\"value\": \"No\"\n\t\t},\n\t\t\"user_outmatrix\": \"WORK.OUTMATRIX\",\n\t\t\"outcluster\": {\n\t\t\t\"library\": \"\",\n\t\t\t\"table\": \"\"\n\t\t},\n\t\t\"outtree\": {\n\t\t\t\"library\": \"\",\n\t\t\t\"table\": \"\"\n\t\t},\n\t\t\"outmatrix\": {\n\t\t\t\"library\": \"\",\n\t\t\t\"table\": \"\"\n\t\t}\n\t},\n\t\"columnExclusions\": [\n\t\t[\n\t\t\t\"vars\",\n\t\t\t\"id\"\n\t\t]\n\t]\n}","templates":{"SAS":"/* Comma-separate vars */\n%let varsc  = %sysfunc(tranwrd(&vars., %bquote( ), %bquote(,)));\n\n/* Set names of outtree and outmatrix to temp datasets if ports are unused */\n%if(%symexist(outtree) = 0)   %then %do;\n\t%let outtree   = __outtree__;\n%end;\n\n%if(%symexist(outmatrix) = 0) %then %do;\n\t%let outmatrix = __outmatrix__;\n%end;\n\n/* Compute series distances using dynamic time warping */\nproc tsmodel data   = &input_table.\n             outobj = (outTSD=casuser.__tsd_out__)\n             ;\n\n\tid &id. interval=obs;\n            \n\tvar &vars.;\n         \n\trequire tsd;\n\n\tsubmit;\n\t\tdeclare object tsd(dtw);        * Add a Time-Series Distance package object with the Dynamic Time Warping algorithm;\n        declare object outTSD(outTSD);  * Holds the output distance measures. Think of it like an output dataset.;\n\n        rc = tsd.Initialize();\n        \trc = tsd.setTarget(&varsc.);      * All variables to analyze;\n            rc = tsd.setOption('missing', 'ZERO');  * Set missing values to 0;\n            rc = tsd.setOption('normalize', 'ABS'); * Normalize using the range (absolute normalization);\n        rc = tsd.Run(); * Run the TSD analysis;\n\n        rc = outTSD.Collect(tsd); * Collect the results from the analysis;\n    endsubmit;\nrun;\n\t\n/* Convert to a lower-triangular distance matrix. It must be in \n   this precise variable order as output by tsmodel. \n   First, store the order and sort it in descending order.\n*/\ndata __tsd_out__;\n\tset casuser.__tsd_out__;\n\torder = _N_;\nrun;\n\nproc sort data=__tsd_out__;\n\tby descending order;\nrun;\n\t\n/* Then transpose it */\nproc transpose data=__tsd_out__ out=__tsd_out_tpose__(drop=_NAME_ _LABEL_);\n\tby TargetSeries notsorted;\n\tid InputSeries;\n\tvar distance;\nrun;\n\n/* Finally, zero self distances for all vars:\n\n   TargetSeries var10 var9 var8 var7 var6 ...\n\t\t  var10 0\t  .    .    .    .    ...\n\t\t  var9  0.5   0    .    .    .    ...\n\t\t  var8  0.7   0.4  0    .    .    ...\n\t\t  var7  0.8   0.3  0.9  0    .    ...\n\t\t  var6  0.4   0.2  0.3  0.8  0    ...\n\t\t  ...   ...   ...  ...  ... ...   ...\n*/\ndata &outmatrix.;\n\tset __tsd_out_tpose__;\n\tarray vars[*] &vars.;\n\n\tif(_N_ = 1) then do;\n\n\t\t/* Store the initial target series and variable */\n\t\t_TargetSeries_ = TargetSeries;\n\t\t_Distance_\t   = vars[dim(vars)];\n\t\t\n\t\t/* Add zero distance for first target series */\n\t\tTargetSeries = vname(vars[dim(vars)]);\n\t\tvars[dim(vars)] = 0;\n\t\toutput;\n\n\t\t/* Re-add initial target series */\n\t\tTargetSeries \t  = _TargetSeries_;\n\t\tvars[dim(vars)]\t  = _Distance_;\n\t\tvars[dim(vars)-1] = 0;\n\t\toutput;\n\tend;\n\n\t\t/* Set self distances to 0 */\n\t\telse do;\n\t\t\tvars[dim(vars)-_N_] = 0;\n\t\t\toutput;\n\t\tend;\n\t\n\tkeep TargetSeries &vars.;\nrun;\n\n/* Cluster time-series and output */\nproc cluster \n\tdata \t= &outmatrix.(type=distance)\n\touttree = &outtree.\n    method  = ward \n\tpseudo;\n\n    id TargetSeries;\n\n    ods output ClusterHistory=&outcluster.;\nrun;\n\n/* Optional: Copy datasets if user specifies */\n%if(&user_outcluster_select.= Yes) %then %do;\n\tdata &user_outcluster.;\n\t\tset &outcluster.;\n\trun;\n%end;\n\n%if(&user_outtree_select. = Yes) %then %do;\n\tdata &user_outtree.;\n\t\tset &outtree.;\n\trun;\n%end;\n\n%if(&user_outmatrix_select. = Yes) %then %do;\n\tdata &user_outmatrix.;\n\t\tset &outmatrix.;\n\trun;\n%end;\n\n/* Clean up casuser */\nproc datasets lib=casuser nolist nowarn;\n\tdelete __tsd_out__;\nquit;\n\n/* Clean up WORK directory */\nproc datasets lib=work nolist nowarn;\n\tdelete __outtree__ \n\t\t   __outmatrix__\n\t\t   __tsd_out_tpose__\n\t\t   __tsd_out__\n\t;\nquit;"}}